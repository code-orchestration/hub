name: Service Issue Handler

on:
  issues:
    types: [opened, labeled]

jobs:
  handle-service-issue:
    runs-on: ubuntu-latest
    # ì´ìŠˆì— 'service' ë ˆì´ë¸”ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    if: contains(github.event.issue.labels.*.name, 'service')
    
    permissions:
      issues: write
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup GitHub CLI
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Extract service name from issue
        id: extract
        run: |
          # ì´ìŠˆ ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ ì´ë¦„ ì¶”ì¶œ (ì˜ˆ: "[Service] my-app" -> "my-app")
          SERVICE_NAME=$(echo "${{ github.event.issue.title }}" | sed -n 's/.*\[Service\]\s*\(.*\)/\1/p' | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          
          # ì„œë¹„ìŠ¤ ì´ë¦„ì´ ì—†ìœ¼ë©´ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì‚¬ìš©
          if [ -z "$SERVICE_NAME" ]; then
            SERVICE_NAME="service-${{ github.event.issue.number }}"
          fi
          
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "Service name: $SERVICE_NAME"
          
      - name: Create new repository
        id: create_repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_PAT }} # ì¡°ì§ ë ˆí¬ ìƒì„± ê¶Œí•œì´ ìˆëŠ” PAT í•„ìš”
        run: |
          SERVICE_NAME="${{ steps.extract.outputs.service_name }}"
          REPO_NAME="${SERVICE_NAME}-service"
          ORG="${{ github.repository_owner }}"
          
          echo "Creating repository: $ORG/$REPO_NAME"
          
          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë ˆí¬ì§€í† ë¦¬ ìƒì„±
          RESPONSE=$(curl -X POST \
            -H "Authorization: token $ADMIN_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/orgs/$ORG/repos \
            -d '{
              "name": "'$REPO_NAME'",
              "description": "Service repository for '$SERVICE_NAME' - Auto-generated from issue #${{ github.event.issue.number }}",
              "private": false,
              "auto_init": true,
              "has_issues": true,
              "has_projects": true,
              "has_wiki": false
            }' 2>/dev/null)
          
          # ë ˆí¬ì§€í† ë¦¬ ìƒì„± í™•ì¸
          if echo "$RESPONSE" | grep -q '"full_name"'; then
            echo "Repository created successfully"
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
            echo "repo_url=https://github.com/$ORG/$REPO_NAME" >> $GITHUB_OUTPUT
          else
            echo "Failed to create repository"
            echo "$RESPONSE"
            exit 1
          fi
          
      - name: Initialize service repository
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          REPO_NAME="${{ steps.create_repo.outputs.repo_name }}"
          ORG="${{ github.repository_owner }}"
          
          # ì„ì‹œ ë””ë ‰í† ë¦¬ì—ì„œ ì‘ì—…
          TEMP_DIR=$(mktemp -d)
          cd $TEMP_DIR
          
          # ìƒˆ ë ˆí¬ì§€í† ë¦¬ í´ë¡ 
          git clone https://github.com/$ORG/$REPO_NAME.git
          cd $REPO_NAME
          
          # ê¸°ë³¸ êµ¬ì¡° ìƒì„±
          cat > README.md << EOF
          # ${{ steps.extract.outputs.service_name }} Service
          
          This repository was auto-generated from issue #${{ github.event.issue.number }} in the hub repository.
          
          ## Original Issue
          
          **Title:** ${{ github.event.issue.title }}
          **Author:** @${{ github.event.issue.user.login }}
          **Created:** ${{ github.event.issue.created_at }}
          
          ## Issue Content
          
          ${{ github.event.issue.body }}
          
          ## Links
          
          - [Original Issue](https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }})
          - [Hub Repository](https://github.com/${{ github.repository }})
          EOF
          
          # ê¸°ë³¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          mkdir -p src docs tests .github/workflows
          
          # ê¸°ë³¸ .gitignore ìƒì„±
          cat > .gitignore << EOF
          # Dependencies
          node_modules/
          vendor/
          
          # Build outputs
          dist/
          build/
          *.exe
          *.dll
          *.so
          *.dylib
          
          # Environment files
          .env
          .env.local
          .env.*.local
          
          # IDE
          .vscode/
          .idea/
          *.swp
          *.swo
          
          # Logs
          logs/
          *.log
          
          # OS
          .DS_Store
          Thumbs.db
          EOF
          
          # ê¸°ë³¸ CI/CD ì›Œí¬í”Œë¡œìš° ìƒì„±
          cat > .github/workflows/ci.yml << 'EOF'
          name: CI
          
          on:
            push:
              branches: [ main ]
            pull_request:
              branches: [ main ]
          
          jobs:
            build:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Build
                  run: echo "Build step placeholder"
                - name: Test
                  run: echo "Test step placeholder"
          EOF
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Initialize service repository from issue #${{ github.event.issue.number }}"
          git push origin main
          
          # ì •ë¦¬
          cd /
          rm -rf $TEMP_DIR
          
      - name: Create issue in new repository
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          REPO_NAME="${{ steps.create_repo.outputs.repo_name }}"
          ORG="${{ github.repository_owner }}"
          
          # ìƒˆ ë ˆí¬ì§€í† ë¦¬ì— ì´ìŠˆ ìƒì„±
          ISSUE_RESPONSE=$(curl -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$ORG/$REPO_NAME/issues \
            -d '{
              "title": "${{ github.event.issue.title }}",
              "body": "## Migrated from Hub Repository\n\nThis issue was migrated from [hub#${{ github.event.issue.number }}](https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}).\n\n### Original Author\n@${{ github.event.issue.user.login }}\n\n### Original Content\n\n${{ github.event.issue.body }}",
              "labels": ["migrated", "service"]
            }')
          
          # ìƒˆ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
          NEW_ISSUE_NUMBER=$(echo "$ISSUE_RESPONSE" | grep -o '"number":[0-9]*' | head -1 | cut -d: -f2)
          echo "New issue created: #$NEW_ISSUE_NUMBER"
          echo "new_issue_number=$NEW_ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
      - name: Update original issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoName = '${{ steps.create_repo.outputs.repo_name }}';
            const repoUrl = '${{ steps.create_repo.outputs.repo_url }}';
            const org = context.repo.owner;
            
            // ì›ë³¸ ì´ìŠˆì— ëŒ“ê¸€ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸš€ Service Repository Created\n\nA new service repository has been created for this issue:\n\n- **Repository:** [${org}/${repoName}](${repoUrl})\n- **Migrated Issue:** [${repoName}#${{ steps.create_repo.outputs.new_issue_number }}](${repoUrl}/issues/${{ steps.create_repo.outputs.new_issue_number }})\n\n### Next Steps\n1. Continue development in the new repository\n2. This issue will be closed automatically\n3. All further discussions should happen in the new repository`
            });
            
            // 'migrated' ë ˆì´ë¸” ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['migrated']
            });
            
            // ì›ë³¸ ì´ìŠˆ ë‹«ê¸°
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });