name: Service Issue Handler

on:
  issues:
    types: [opened, labeled]

jobs:
  handle-service-issue:
    runs-on: ubuntu-latest
    # ì´ìŠˆì— 'service' ë ˆì´ë¸”ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    if: contains(github.event.issue.labels.*.name, 'service')
    
    permissions:
      issues: write
      contents: write
      actions: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup GitHub CLI
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Extract service name from issue
        id: extract
        run: |
          # ì´ìŠˆ ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ ì´ë¦„ ì¶”ì¶œ (ì˜ˆ: "[Service] my-app" -> "my-app")
          SERVICE_NAME=$(echo "${{ github.event.issue.title }}" | sed -n 's/.*\[Service\]\s*\(.*\)/\1/p' | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          
          # ì„œë¹„ìŠ¤ ì´ë¦„ì´ ì—†ìœ¼ë©´ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì‚¬ìš©
          if [ -z "$SERVICE_NAME" ]; then
            SERVICE_NAME="service-${{ github.event.issue.number }}"
          fi
          
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "Service name: $SERVICE_NAME"
          
      - name: Create new repository
        id: create_repo
        env:
          GITHUB_TOKEN: ${{ secrets.ADMIN_PAT || secrets.GITHUB_TOKEN }}
        run: |
          SERVICE_NAME="${{ steps.extract.outputs.service_name }}"
          REPO_NAME="${SERVICE_NAME}-service"
          ORG="${{ github.repository_owner }}"
          
          echo "Creating repository: $ORG/$REPO_NAME"
          
          # PATê°€ ìˆëŠ”ì§€ í™•ì¸
          if [ -n "${{ secrets.ADMIN_PAT }}" ]; then
            echo "Using ADMIN_PAT for repository creation"
            # ë ˆí¬ì§€í† ë¦¬ ìƒì„± ì‹œë„
            if gh repo create "$ORG/$REPO_NAME" \
              --public \
              --description "Service repository for $SERVICE_NAME - Auto-generated from issue #${{ github.event.issue.number }}" \
              --add-readme 2>/dev/null; then
              echo "Repository created successfully"
              echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
              echo "repo_url=https://github.com/$ORG/$REPO_NAME" >> $GITHUB_OUTPUT
            else
              # ë ˆí¬ì§€í† ë¦¬ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°
              if gh repo view "$ORG/$REPO_NAME" &>/dev/null; then
                echo "Repository already exists, using existing repository"
                echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
                echo "repo_url=https://github.com/$ORG/$REPO_NAME" >> $GITHUB_OUTPUT
              else
                echo "Failed to create repository"
                exit 1
              fi
            fi
          else
            echo "âš ï¸ ADMIN_PAT not configured. Cannot create organization repository."
            echo "Please add ADMIN_PAT secret with repo creation permissions."
            echo "Instructions: https://github.com/${{ github.repository }}/blob/main/.github/SETUP_SERVICE_WORKFLOW.md"
            
            # ëŒ€ì²´ ë°©ì•ˆ: ì´ìŠˆì— ëŒ“ê¸€ë¡œ ì•ˆë‚´
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
            echo "repo_url=https://github.com/$ORG/$REPO_NAME" >> $GITHUB_OUTPUT
            echo "repo_creation_failed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Initialize service repository
        if: steps.create_repo.outputs.repo_creation_failed != 'true'
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT || secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME="${{ steps.create_repo.outputs.repo_name }}"
          ORG="${{ github.repository_owner }}"
          
          # GitHub CLIë¡œ ì¸ì¦
          gh auth login --with-token <<< "$GH_TOKEN"
          
          # ì„ì‹œ ë””ë ‰í† ë¦¬ì—ì„œ ì‘ì—…
          TEMP_DIR=$(mktemp -d)
          cd $TEMP_DIR
          
          # ìƒˆ ë ˆí¬ì§€í† ë¦¬ í´ë¡ 
          gh repo clone "$ORG/$REPO_NAME" -- --depth=1
          cd $REPO_NAME
          
          # ê¸°ë³¸ êµ¬ì¡° ìƒì„±
          cat > README.md << EOF
          # ${{ steps.extract.outputs.service_name }} Service
          
          This repository was auto-generated from issue #${{ github.event.issue.number }} in the hub repository.
          
          ## Original Issue
          
          **Title:** ${{ github.event.issue.title }}
          **Author:** @${{ github.event.issue.user.login }}
          **Created:** ${{ github.event.issue.created_at }}
          
          ## Issue Content
          
          ${{ github.event.issue.body }}
          
          ## Links
          
          - [Original Issue](https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }})
          - [Hub Repository](https://github.com/${{ github.repository }})
          EOF
          
          # ê¸°ë³¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          mkdir -p src docs tests .github/workflows
          
          # ê¸°ë³¸ .gitignore ìƒì„±
          cat > .gitignore << EOF
          # Dependencies
          node_modules/
          vendor/
          
          # Build outputs
          dist/
          build/
          *.exe
          *.dll
          *.so
          *.dylib
          
          # Environment files
          .env
          .env.local
          .env.*.local
          
          # IDE
          .vscode/
          .idea/
          *.swp
          *.swo
          
          # Logs
          logs/
          *.log
          
          # OS
          .DS_Store
          Thumbs.db
          EOF
          
          # ê¸°ë³¸ CI/CD ì›Œí¬í”Œë¡œìš° ìƒì„±
          cat > .github/workflows/ci.yml << 'EOF'
          name: CI
          
          on:
            push:
              branches: [ main ]
            pull_request:
              branches: [ main ]
          
          jobs:
            build:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Build
                  run: echo "Build step placeholder"
                - name: Test
                  run: echo "Test step placeholder"
          EOF
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Initialize service repository from issue #${{ github.event.issue.number }}"
          git push origin main
          
          # ì •ë¦¬
          cd /
          rm -rf $TEMP_DIR
          
      - name: Create issue in new repository
        id: new_issue
        if: steps.create_repo.outputs.repo_creation_failed != 'true'
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT || secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_URL: ${{ github.repository }}
        run: |
          REPO_NAME="${{ steps.create_repo.outputs.repo_name }}"
          ORG="${{ github.repository_owner }}"
          
          # GitHub CLIë¡œ ì¸ì¦
          gh auth login --with-token <<< "$GH_TOKEN"
          
          # ì´ìŠˆ ë³¸ë¬¸ì„ íŒŒì¼ë¡œ ìƒì„± (escape ë¬¸ì œ í•´ê²°)
          cat > issue_body.md << 'ISSUE_CONTENT_EOF'
          ## Migrated from Hub Repository
          
          This issue was migrated from [hub#${ISSUE_NUMBER}](https://github.com/${REPO_URL}/issues/${ISSUE_NUMBER}).
          
          ### Original Author
          @${ISSUE_AUTHOR}
          
          ### Original Content
          
          ${ISSUE_BODY}
          ISSUE_CONTENT_EOF
          
          # í™˜ê²½ ë³€ìˆ˜ ì¹˜í™˜
          envsubst < issue_body.md > issue_body_final.md
          
          # ìƒˆ ë ˆí¬ì§€í† ë¦¬ì— ì´ìŠˆ ìƒì„±
          NEW_ISSUE_URL=$(gh issue create \
            --repo "$ORG/$REPO_NAME" \
            --title "$ISSUE_TITLE" \
            --body-file issue_body_final.md \
            --label "migrated,service" 2>/dev/null || echo "")
          
          # ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
          if [ -n "$NEW_ISSUE_URL" ]; then
            NEW_ISSUE_NUMBER=$(echo "$NEW_ISSUE_URL" | grep -o '[0-9]*$')
            echo "New issue created: #$NEW_ISSUE_NUMBER"
            echo "new_issue_number=$NEW_ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "Warning: Could not create issue in new repository"
            echo "new_issue_number=1" >> $GITHUB_OUTPUT
          fi
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f issue_body.md issue_body_final.md
          
      - name: Update original issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoName = '${{ steps.create_repo.outputs.repo_name }}';
            const repoUrl = '${{ steps.create_repo.outputs.repo_url }}';
            const org = context.repo.owner;
            const repoCreationFailed = '${{ steps.create_repo.outputs.repo_creation_failed }}' === 'true';
            
            if (repoCreationFailed) {
              // PATê°€ ì—†ì–´ì„œ ë ˆí¬ì§€í† ë¦¬ ìƒì„± ì‹¤íŒ¨ ì‹œ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## âš ï¸ Manual Repository Creation Required\n\n### Repository Name\n\`${repoName}\`\n\n### Why this happened?\nThe workflow needs an ADMIN_PAT secret with repository creation permissions to automatically create organization repositories.\n\n### How to fix:\n1. Create a Personal Access Token with \`repo\` and \`admin:org\` permissions\n2. Add it as a secret named \`ADMIN_PAT\` in repository settings\n3. Re-run this workflow or create a new service issue\n\n### Manual steps:\n1. Create repository: [Create ${repoName}](https://github.com/organizations/${org}/repositories/new?name=${repoName})\n2. Copy issue content to new repository\n3. Close this issue when done\n\n[Setup Instructions](https://github.com/${{ github.repository }}/blob/main/.github/SETUP_SERVICE_WORKFLOW.md)`
              });
              
              // 'needs-manual-setup' ë ˆì´ë¸” ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['needs-manual-setup']
              });
            } else {
              // ì •ìƒì ìœ¼ë¡œ ë ˆí¬ì§€í† ë¦¬ ìƒì„±ëœ ê²½ìš°
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ğŸš€ Service Repository Created\n\nA new service repository has been created for this issue:\n\n- **Repository:** [${org}/${repoName}](${repoUrl})\n- **Migrated Issue:** [${repoName}#${{ steps.new_issue.outputs.new_issue_number }}](${repoUrl}/issues/${{ steps.new_issue.outputs.new_issue_number }})\n\n### Next Steps\n1. Continue development in the new repository\n2. This issue will be closed automatically\n3. All further discussions should happen in the new repository`
              });
              
              // 'migrated' ë ˆì´ë¸” ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['migrated']
              });
              
              // ì›ë³¸ ì´ìŠˆ ë‹«ê¸°
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
            }